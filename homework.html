<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Total Olympic Medals by Country in 2016</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
  <style>
    body { margin:16px; font-family: system-ui, sans-serif; background:#fafafa; }
    #vis { max-width: 980px; margin: 0 auto; }
  </style>
</head>
<body>
  <h2>Total Olympic Medals by Country in 2016</h2>
  <div id="vis"></div>

  <script>
    const YEAR_FIXED = 2016;

    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "width": 950,
      "height": 520,
      "projection": {"type": "equalEarth"},
      "title": {
        "text": "Total Olympic Medals",
        "subtitle": String(YEAR_FIXED),
        "anchor": "start"
      },
      "layer": [
        {
          "data": {
            "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/2_symbol_map/js/WorldMapWithGraticules.topojson",
            "format": {"type": "topojson", "feature": "ne_110m_graticules_30"}
          },
          "mark": {"type":"geoshape","fill":null,"stroke":"#d0d0d0","strokeWidth":0.6}
        },
        {
          "data": {
            "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/3_choropleth_map/js/ne_110m_admin_0_countries.topojson",
            "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
          },
          "mark": {"type":"geoshape","stroke":"#cfcfcf","strokeWidth":0.3,"fill":"#f5f5f5"}
        },
        {
          "data": {
            "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/3_choropleth_map/js/ne_110m_admin_0_countries.topojson",
            "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
          },
          "transform": [
            { "calculate": "upper(datum.properties && datum.properties.ISO_A3 ? datum.properties.ISO_A3 : (datum.properties && datum.properties.ADM0_A3 ? datum.properties.ADM0_A3 : ''))", "as": "iso3" },
            { "filter": "datum.iso3 !== '' && datum.iso3 !== '---' && datum.iso3 !== '-99'" },

            {
              "lookup": "iso3",
              "from": {
                "data": {
                  "values": [
                    {"iso3":"DEU","noc":"GER"},{"iso3":"NLD","noc":"NED"},{"iso3":"CHE","noc":"SUI"},
                    {"iso3":"GRC","noc":"GRE"},{"iso3":"IRN","noc":"IRI"},{"iso3":"CHL","noc":"CHI"},
                    {"iso3":"SAU","noc":"KSA"},{"iso3":"ARE","noc":"UAE"},{"iso3":"KWT","noc":"KUW"},
                    {"iso3":"VNM","noc":"VIE"},{"iso3":"KHM","noc":"CAM"},{"iso3":"IDN","noc":"INA"},
                    {"iso3":"MYS","noc":"MAS"},{"iso3":"MNG","noc":"MGL"},{"iso3":"SVN","noc":"SLO"},
                    {"iso3":"NGA","noc":"NGR"}
                  ]
                },
                "key": "iso3",
                "fields": ["noc"]
              },
              "as": ["noc_maybe"]
            },
            { "calculate": "isValid(datum.noc_maybe) ? datum.noc_maybe : datum.iso3", "as": "noc" },

            { "calculate": "datum.noc + '|' + " + YEAR_FIXED + " + '|Gold'",   "as": "key_gold"   },
            { "calculate": "datum.noc + '|' + " + YEAR_FIXED + " + '|Silver'", "as": "key_silver" },
            { "calculate": "datum.noc + '|' + " + YEAR_FIXED + " + '|Bronze'", "as": "key_bronze" },

            {
              "lookup": "key_gold",
              "from": {
                "data": {
                  "url": "https://raw.githubusercontent.com/davidlie883/3179/main/olympic_has_medal_noc_year_commas.csv",
                  "format": {"type": "csv"}
                },
                "key": "key_iso",
                "fields": ["medal_count","has_medal"]
              },
              "as": ["gold_count_raw","gold_has_raw"]
            },
            {
              "lookup": "key_silver",
              "from": {
                "data": {
                  "url": "https://raw.githubusercontent.com/davidlie883/3179/main/olympic_has_medal_noc_year_commas.csv",
                  "format": {"type": "csv"}
                },
                "key": "key_iso",
                "fields": ["medal_count","has_medal"]
              },
              "as": ["silver_count_raw","silver_has_raw"]
            },
            {
              "lookup": "key_bronze",
              "from": {
                "data": {
                  "url": "https://raw.githubusercontent.com/davidlie883/3179/main/olympic_has_medal_noc_year_commas.csv",
                  "format": {"type": "csv"}
                },
                "key": "key_iso",
                "fields": ["medal_count","has_medal"]
              },
              "as": ["bronze_count_raw","bronze_has_raw"]
            },

            { "calculate": "toNumber(datum.gold_count_raw)",   "as": "gold_count_num_try"   },
            { "calculate": "toNumber(datum.silver_count_raw)", "as": "silver_count_num_try" },
            { "calculate": "toNumber(datum.bronze_count_raw)", "as": "bronze_count_num_try" },

            { "calculate": "toNumber(datum.gold_has_raw)",     "as": "gold_has_num_try"     },
            { "calculate": "toNumber(datum.silver_has_raw)",   "as": "silver_has_num_try"   },
            { "calculate": "toNumber(datum.bronze_has_raw)",   "as": "bronze_has_num_try"   },

            { "calculate": "isValid(datum.gold_count_num_try)   ? datum.gold_count_num_try   : (isValid(datum.gold_has_num_try)   ? datum.gold_has_num_try   : 0)", "as": "gold_count"   },
            { "calculate": "isValid(datum.silver_count_num_try) ? datum.silver_count_num_try : (isValid(datum.silver_has_num_try) ? datum.silver_has_num_try : 0)", "as": "silver_count" },
            { "calculate": "isValid(datum.bronze_count_num_try) ? datum.bronze_count_num_try : (isValid(datum.bronze_has_num_try) ? datum.bronze_has_num_try : 0)", "as": "bronze_count" },

            { "calculate": "datum.gold_count + datum.silver_count + datum.bronze_count", "as": "total_medals" },
            { "calculate": String(YEAR_FIXED), "as": "year" }
          ],

          "mark": {"type":"geoshape","stroke":"#bdbdbd","strokeWidth":0.3},

          "encoding": {
            "color": {
              "field": "total_medals",
              "type": "quantitative",
              "title": "Total medals",
              "scale": { "scheme": "reds", "domainMin": 0 }
            },
            "tooltip": [
              {"field":"properties.NAME","title":"Country"},
              {"field":"noc","title":"NOC"},
              {"field":"year","title":"Year"},
              {"field":"gold_count","title":"Gold"},
              {"field":"silver_count","title":"Silver"},
              {"field":"bronze_count","title":"Bronze"},
              {"field":"total_medals","title":"Total"}
            ]
          }
        }
      ]
    };

    vegaEmbed("#vis", spec, {mode:"vega-lite", actions:false}).catch(console.warn);
  </script>
</body>
</html>
